# 扫码数据接口权限错误解决方案

## 问题描述

访问扫码数据接口时出现错误：
```
您没有执行该操作的权限。: /api/code_info/scan_data/
```

## 问题原因

### 1. 权限控制机制

系统使用 `CustomPermission` 类进行接口权限控制（位于 `dvadmin/utils/permission.py`）：

- 超级管理员可以直接访问所有接口
- 普通用户需要通过角色的 `RoleMenuButtonPermission` 表中的按钮权限来访问接口

### 2. 权限检查流程

```python
# 1. 获取用户的所有角色
role_id_list = request.user.role.values_list('id', flat=True)

# 2. 获取这些角色拥有的所有接口权限
userApiList = RoleMenuButtonPermission.objects.filter(role__in=role_id_list).values(
    permission__api=F('menu_button__api'),
    permission__method=F('menu_button__method')
)

# 3. 检查当前请求的接口是否在用户权限列表中
```

### 3. 根本原因

从 `plugins/code_info/fixtures/init_menu.json` 可以看到，扫码数据菜单的 `menu_button` 配置为空：

```json
{
    "name": "扫码数据",
    "menu_button": [],  // 空数组！
    "menu_field": []
}
```

这意味着：
1. 数据库中没有为扫码数据菜单创建任何按钮权限（MenuButton）
2. 角色没有被分配扫码数据的接口权限（RoleMenuButtonPermission）
3. 用户无法访问 `/api/code_info/scan_data/` 接口

## 解决方案

### 方法一：运行修复脚本（推荐）

运行自动修复脚本：

```bash
cd backend
python fix_scan_data_permission.py
```

这个脚本会：
1. 为扫码数据菜单创建5个按钮权限（查询、单例、新增、编辑、删除）
2. 为管理员角色分配这些按钮权限
3. 显示操作结果

### 方法二：手动执行

#### 步骤1：创建按钮权限

```python
from dvadmin.system.models import Menu, MenuButton

# 获取扫码数据菜单
scan_data_menu = Menu.objects.get(component_name='scanData')

# 创建按钮权限
buttons = [
    {'name': '查询', 'value': 'scanData:Search', 'api': '/api/code_info/scan_data/', 'method': 0},
    {'name': '单例', 'value': 'scanData:Retrieve', 'api': '/api/code_info/scan_data/{id}/', 'method': 0},
    {'name': '新增', 'value': 'scanData:Create', 'api': '/api/code_info/scan_data/', 'method': 1},
    {'name': '编辑', 'value': 'scanData:Update', 'api': '/api/code_info/scan_data/{id}/', 'method': 2},
    {'name': '删除', 'value': 'scanData:Delete', 'api': '/api/code_info/scan_data/{id}/', 'method': 3}
]

for btn_data in buttons:
    MenuButton.objects.get_or_create(
        menu=scan_data_menu,
        value=btn_data['value'],
        defaults={
            'name': btn_data['name'],
            'api': btn_data['api'],
            'method': btn_data['method'],
            'status': True
        }
    )
```

#### 步骤2：为角色分配按钮权限

```python
from dvadmin.system.models import Role, MenuButton, RoleMenuButtonPermission

# 获取管理员角色
admin_role = Role.objects.get(key='admin')

# 获取扫码数据菜单的所有按钮
scan_data_menu = Menu.objects.get(component_name='scanData')
buttons = MenuButton.objects.filter(menu_id=scan_data_menu.id)

# 为角色分配按钮权限
for button in buttons:
    RoleMenuButtonPermission.objects.get_or_create(
        role=admin_role,
        menu_button=button,
        defaults={'data_range': 0}
    )
```

### 方法三：使用超级管理员账号

如果您有超级管理员账号（`is_superuser=True`），可以直接访问所有接口，无需配置权限。

## 验证修复结果

### 1. 检查按钮权限是否创建成功

```python
from dvadmin.system.models import Menu, MenuButton

scan_data_menu = Menu.objects.get(component_name='scanData')
buttons = MenuButton.objects.filter(menu_id=scan_data_menu.id)

print(f'扫码数据菜单的按钮数量: {buttons.count()}')
for btn in buttons:
    print(f'  - {btn.name} ({btn.value})')
```

### 2. 检查角色权限是否分配成功

```python
from dvadmin.system.models import Role, RoleMenuButtonPermission

admin_role = Role.objects.get(key='admin')
permissions = RoleMenuButtonPermission.objects.filter(role=admin_role)

print(f'管理员角色的按钮权限数量: {permissions.count()}')
```

### 3. 测试接口访问

1. 重新登录系统（重要！）
2. 访问扫码数据页面
3. 尝试进行查询、新增、编辑、删除操作

## 为其他角色分配权限

如果需要为其他角色分配扫码数据权限：

```python
from dvadmin.system.models import Role, Menu, MenuButton, RoleMenuButtonPermission

# 获取目标角色
target_role = Role.objects.get(key='public')  # 或其他角色

# 获取扫码数据菜单的按钮
scan_data_menu = Menu.objects.get(component_name='scanData')
buttons = MenuButton.objects.filter(menu_id=scan_data_menu.id)

# 为角色分配按钮权限
for button in buttons:
    RoleMenuButtonPermission.objects.get_or_create(
        role=target_role,
        menu_button=button,
        defaults={'data_range': 0}
    )
```

## 常见问题

### Q: 为什么需要配置按钮权限？

A: 这是系统的 RBAC（基于角色的访问控制）权限机制。每个接口都需要通过按钮权限来控制访问，确保安全性。

### Q: 执行脚本后仍然没有权限？

A: 请检查：
1. 是否重新登录了系统（权限需要重新登录才能生效）
2. 当前用户是否属于管理员角色
3. 浏览器是否缓存了旧数据（尝试清除缓存或使用无痕模式）

### Q: 如何批量为多个菜单添加按钮权限？

A: 可以参考 `diagnose_and_fix_permissions.py` 脚本，它会自动为所有没有按钮的菜单添加按钮权限。

### Q: 接口白名单是什么？

A: 接口白名单（ApiWhiteList）中的接口不需要权限验证，所有用户都可以访问。可以在「系统管理」→「接口白名单」中配置。

## 相关文件

- `fix_scan_data_permission.py` - 扫码数据权限修复脚本
- `plugins/code_info/views/scan_data.py` - 扫码数据视图
- `dvadmin/utils/permission.py` - 权限控制逻辑
- `plugins/code_info/fixtures/init_menu.json` - 菜单初始化数据
